// ========================================
// PDF Generator Module
// Generates dark-themed PDF reports using jsPDF
// ========================================

const PDFGenerator = {
    /**
     * Generate attendance report PDF
     * @param {Array} reportData - Report data array
     * @param {string} reportType - 'failures', 'performers', or 'duration'
     * @param {Object} dateRange - {start: string, end: string}
     * @param {string} viewMode - 'individual' or 'bo-wise'
     * @param {string} userRole - Current user role
     * @param {string} userName - Current user name
     */
    async generateAttendanceReportPDF(reportData, reportType, dateRange, viewMode, userRole, userName) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        // Dark theme colors
        const colors = {
            background: [30, 41, 59],      // #1e293b
            header: [51, 65, 85],          // #334155
            text: [248, 250, 252],         // #f8fafc
            textDim: [203, 213, 225],      // #cbd5e1
            border: [71, 85, 105],         // #475569
            accent: [99, 102, 241]         // #6366f1 (indigo)
        };

        let yPosition = 15;

        // ====================================
        // HEADER SECTION
        // ====================================

        // Official header background
        doc.setFillColor(...colors.header);
        doc.rect(0, 0, 210, 40, 'F');

        // Official title
        doc.setTextColor(...colors.text);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Biometric Attendance Compliance Report', 105, 15, { align: 'center' });

        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('O/o AG (A&E), Kolkata', 105, 22, { align: 'center' });

        // Report type and date range
        doc.setFontSize(10);
        doc.setTextColor(...colors.textDim);
        const reportTitle = this.getReportTitle(reportType, viewMode);
        doc.text(reportTitle, 105, 30, { align: 'center' });
        doc.text(`Period: ${this.formatDate(dateRange.start)} to ${this.formatDate(dateRange.end)}`, 105, 36, { align: 'center' });

        yPosition = 45;

        // ====================================
        // METADATA SECTION
        // ====================================

        doc.setFontSize(9);
        doc.setTextColor(...colors.text);
        doc.text(`Generated by: ${userName} (${userRole.toUpperCase()})`, 15, yPosition);
        doc.text(`Generated on: ${new Date().toLocaleString('en-IN')}`, 15, yPosition + 5);
        doc.text(`Total Records: ${reportData.length}`, 15, yPosition + 10);

        yPosition += 18;

        // ====================================
        // DATA TABLE
        // ====================================

        const tableData = this.formatReportDataForPDF(reportData, reportType, viewMode);

        doc.autoTable({
            head: [tableData.headers],
            body: tableData.rows,
            startY: yPosition,
            theme: 'grid',
            styles: {
                fontSize: 8,
                cellPadding: 3,
                textColor: colors.text,
                lineColor: colors.border,
                lineWidth: 0.1
            },
            headStyles: {
                fillColor: colors.header,
                textColor: colors.text,
                fontStyle: 'bold',
                halign: 'center'
            },
            bodyStyles: {
                fillColor: colors.background
            },
            alternateRowStyles: {
                fillColor: [20, 30, 48] // Slightly lighter
            },
            columnStyles: this.getColumnStyles(reportType, viewMode),
            didDrawPage: (data) => {
                // Footer with page numbers
                const pageCount = doc.internal.getNumberOfPages();
                const pageNumber = doc.internal.getCurrentPageInfo().pageNumber;

                doc.setFontSize(8);
                doc.setTextColor(...colors.textDim);
                doc.text(
                    `Page ${pageNumber} of ${pageCount}`,
                    105,
                    doc.internal.pageSize.height - 10,
                    { align: 'center' }
                );

                // Footer line
                doc.setDrawColor(...colors.border);
                doc.setLineWidth(0.5);
                doc.line(15, doc.internal.pageSize.height - 15, 195, doc.internal.pageSize.height - 15);
            }
        });

        // ====================================
        // SAVE PDF
        // ====================================

        const fileName = this.generateFileName(reportType, viewMode, dateRange);
        doc.save(fileName);
    },

    /**
     * Get report title based on type and view mode
     */
    getReportTitle(reportType, viewMode) {
        const prefix = viewMode === 'bo-wise' ? 'BO-wise ' : '';

        switch (reportType) {
            case 'failures':
                return `${prefix}Attendance Failure Analysis`;
            case 'performers':
                return `${prefix}Best Performers Report`;
            case 'duration':
                return `${prefix}Office Duration Analysis`;
            default:
                return `${prefix}Attendance Report`;
        }
    },

    /**
     * Format date for display
     */
    formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    },

    /**
     * Format report data into table structure
     */
    formatReportDataForPDF(reportData, reportType, viewMode) {
        if (viewMode === 'bo-wise') {
            return this.formatBOWiseData(reportData, reportType);
        } else {
            return this.formatIndividualData(reportData, reportType);
        }
    },

    /**
     * Format individual employee data
     */
    formatIndividualData(reportData, reportType) {
        let headers, rows;

        switch (reportType) {
            case 'failures':
                headers = ['Sl No', 'Name', 'Designation', 'Section', 'Total Days', 'Absent Days', 'Failure Rate'];
                rows = reportData.map((emp, index) => [
                    index + 1,
                    emp.name,
                    emp.designation,
                    emp.section,
                    emp.totalDays,
                    emp.absentDays,
                    `${emp.failureRate}%`
                ]);
                break;

            case 'performers':
                headers = ['Sl No', 'Name', 'Designation', 'Section', 'Total Days', 'Present Days', 'Attendance %'];
                rows = reportData.map((emp, index) => [
                    index + 1,
                    emp.name,
                    emp.designation,
                    emp.section,
                    emp.totalDays,
                    emp.presentDays,
                    `${emp.attendanceRate}%`
                ]);
                break;

            case 'duration':
                headers = ['Sl No', 'Name', 'Designation', 'Section', 'Days', 'Avg In', 'Avg Out', 'Avg Duration'];
                rows = reportData.map((emp, index) => [
                    index + 1,
                    emp.name,
                    emp.designation,
                    emp.section,
                    emp.daysWithTime,
                    emp.avgInTime,
                    emp.avgOutTime,
                    emp.avgDurationFormatted
                ]);
                break;

            default:
                headers = ['Sl No', 'Name', 'Section'];
                rows = reportData.map((emp, index) => [
                    index + 1,
                    emp.name,
                    emp.section
                ]);
        }

        return { headers, rows };
    },

    /**
     * Format BO-wise aggregated data
     */
    formatBOWiseData(reportData, reportType) {
        let headers, rows;

        switch (reportType) {
            case 'failures':
                headers = ['Sl No', 'Branch Officer', 'Total Employees', 'Total Absent Days', 'Avg Failure Rate'];
                rows = reportData.map((bo, index) => [
                    index + 1,
                    bo.boName,
                    bo.totalEmployees,
                    bo.totalAbsentDays,
                    `${bo.avgFailureRate}%`
                ]);
                break;

            case 'performers':
                headers = ['Sl No', 'Branch Officer', 'Total Employees', 'Total Present Days', 'Avg Attendance %'];
                rows = reportData.map((bo, index) => [
                    index + 1,
                    bo.boName,
                    bo.totalEmployees,
                    bo.totalPresentDays,
                    `${bo.avgAttendanceRate}%`
                ]);
                break;

            case 'duration':
                headers = ['Sl No', 'Branch Officer', 'Total Employees', 'Avg Office Duration'];
                rows = reportData.map((bo, index) => [
                    index + 1,
                    bo.boName,
                    bo.totalEmployees,
                    bo.avgDuration
                ]);
                break;

            default:
                headers = ['Sl No', 'Branch Officer', 'Total Employees'];
                rows = reportData.map((bo, index) => [
                    index + 1,
                    bo.boName,
                    bo.totalEmployees
                ]);
        }

        return { headers, rows };
    },

    /**
     * Get column styles for autoTable
     */
    getColumnStyles(reportType, viewMode) {
        if (viewMode === 'bo-wise') {
            return {
                0: { halign: 'center', cellWidth: 15 },  // Sl No
                1: { halign: 'left', cellWidth: 80 },    // BO Name
                2: { halign: 'center', cellWidth: 30 }   // Total Employees
            };
        } else {
            return {
                0: { halign: 'center', cellWidth: 12 },  // Sl No
                1: { halign: 'left', cellWidth: 45 },    // Name
                2: { halign: 'left', cellWidth: 40 },    // Designation
                3: { halign: 'left', cellWidth: 35 }     // Section
            };
        }
    },

    /**
     * Generate filename for PDF
     */
    generateFileName(reportType, viewMode, dateRange) {
        const prefix = viewMode === 'bo-wise' ? 'BOWise_' : '';
        const typeMap = {
            'failures': 'AttendanceFailures',
            'performers': 'BestPerformers',
            'duration': 'OfficeDuration'
        };
        const typeName = typeMap[reportType] || 'Report';
        const dateStr = dateRange.start.replace(/-/g, '');

        return `${prefix}${typeName}_${dateStr}.pdf`;
    }
};
